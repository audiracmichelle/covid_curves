
```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
#library(lubridate)
library(usmap)
library(viridis)
library(gridExtra)
library(cowplot)
```

## Read data

* county_set

```{r}
county_train_ <- read_feather('./county_train_.feather')
```

```{r}
county_set_ <- county_train_ %>% 
  distinct(fips, county, state, nchs, pop, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome,
           days_btwn_stayhome_thresh, days_btwn_decrease_thresh,
           decrease_50_total_visiting, decrease_50_recreation_visiting, decrease_50_school_visits, 
           decrease_40_total_visiting, decrease_40_recreation_visiting, decrease_40_school_visits, 
           decrease_on_stayhome, roll_decrease_on_stayhome, min_decrease)

length(unique(county_set_$fips))

table(county_set_$nchs)
```

```{r}
county_map <- county_set_ %>% 
  mutate(intrv = if_else(!is.na(stayhome) & !is.na(decrease_50_total_visiting), 
                         "both", as.character(NA)), 
         intrv = if_else(is.na(stayhome), "decrease only", intrv), 
         intrv = if_else(is.na(decrease_50_total_visiting), "stayhome only", intrv))

plot_usmap(data = county_map, 
           values = "intrv", 
           size = 0.1) + 
  theme(legend.position = "right") + 
  theme(legend.title = element_blank()) + 
    scale_fill_discrete(na.value="white")
```

* county_set

```{r}
county_train_stayhome <- read_feather('./county_train_stayhome.feather')
county_train_decrease <- read_feather('./county_train_decrease.feather')
```

```{r}
stayhome_set <- county_train_stayhome %>% 
  distinct(fips, county, state, nchs, pop, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome,
           days_btwn_stayhome_thresh, days_btwn_decrease_thresh,
           decrease_50_total_visiting, decrease_50_recreation_visiting, decrease_50_school_visits, 
           decrease_40_total_visiting, decrease_40_recreation_visiting, decrease_40_school_visits, 
           decrease_on_stayhome, roll_decrease_on_stayhome, min_decrease)
decrease_set <- county_train_decrease %>% 
  distinct(fips, county, state, nchs, pop, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome, 
           days_btwn_stayhome_thresh, days_btwn_decrease_thresh,
           decrease_50_total_visiting, decrease_50_recreation_visiting, decrease_50_school_visits, 
           decrease_40_total_visiting, decrease_40_recreation_visiting, decrease_40_school_visits,  
           decrease_on_stayhome, roll_decrease_on_stayhome, min_decrease)

length(unique(c(stayhome_set$fips, decrease_set$fips)))

county_set <- full_join(stayhome_set, decrease_set)

table(county_set$nchs)
```

```{r}
length(setdiff(stayhome_set$fips, decrease_set$fips))
length(setdiff(decrease_set$fips, stayhome_set$fips))
```

## NCHS prop

* county_set

```{r}
nchs <- read_feather("./nchs.feather")
```

```{r}
table(nchs$nchs)
tot <- as.numeric(tapply(nchs$popul, nchs$nchs, sum, na.rm = TRUE))
set <- as.numeric(tapply(county_set_$pop, county_set_$nchs, sum, na.rm = TRUE))
set / tot
set
```

* county_set

```{r}
table(nchs$nchs)
tot <- as.numeric(tapply(nchs$popul, nchs$nchs, sum, na.rm = TRUE))
set <- as.numeric(tapply(county_set$pop, county_set$nchs, sum, na.rm = TRUE))
set / tot
set
```

## Interventions

* county_set

```{r}
intrv_labels = c("non-essential \n business closures", 
                 "gatherings of \n 50+ ban", 
                 "gatherings of \n 500+ ban", 
                 "restaurants \n closures", 
                 "schools closures", 
                 "stay-at-home \n orders")

p1 <- county_set_ %>% 
  select(fips, gt50, gt500, 
         schools, restaurants, entertainment, 
         stayhome) %>% 
  gather(key, value, -fips) %>% 
  mutate(key = factor(key, labels = intrv_labels), 
         title = "Array of non-pharmaceutical interventions") %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  scale_x_date(name = "", limits = as.Date(c("2020-03-10", "2020-04-15"))) + 
  scale_y_continuous(limits = c(0,500)) +
  theme(axis.text.x =  element_blank(), 
        legend.key.width = unit(10, "pt")) + 
  labs(fill = "") +
  facet_wrap(~ title)
leg1 <- get_legend(p1 + theme(legend.box.margin = margin(0, 0, 0, 0)))
p1
```

```{r}
intrv_labels = c("50% decrease in \n leisure visits", 
                 "50% decrease in \n education visits",
                 "50% decrease in \n total visits")

p2 <- county_set %>% 
  select(fips, 
         decrease_50_school_visits, 
         decrease_50_recreation_visiting,
         decrease_50_total_visiting) %>% 
  gather(key, value, -fips) %>% 
  mutate(key = factor(key, labels = intrv_labels), 
         title = "Array of mobility interventions") %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  scale_x_date(name = "", limits = as.Date(c("2020-03-10", "2020-04-15"))) + 
  scale_y_continuous(limits = c(0,500)) + 
  theme(legend.key.width = unit(10, "pt")) + 
  labs(fill = "") +
  facet_wrap(~ title)
leg2 <- get_legend(p2 + theme(legend.box.margin = margin(0, 0, 0, 0)))
p2
```

```{r}
prow1 <- plot_grid(p1 + theme(legend.position="none"), 
                   leg1,  ncol = 2, rel_widths = c(2,1))
prow2 <- plot_grid(p2 + theme(legend.position="none"), 
                   leg2, ncol = 2, rel_widths = c(2,1))
plot_grid(prow1, prow2, nrow = 2)
ggsave("intrv_timeline.pdf", width = 5, height = 4)
```

* county_set

```{r}
intrv_labels = c("non-essential \n business closures", 
                 "gatherings of \n 50+ ban", 
                 "gatherings of \n 500+ ban", 
                 "restaurants \n closures", 
                 "schools closures", 
                 "stay-at-home \n orders")

p1 <- county_set %>% 
  select(fips, gt50, gt500, 
         schools, restaurants, entertainment, 
         stayhome) %>% 
  gather(key, value, -fips) %>% 
  mutate(key = factor(key, labels = intrv_labels), 
         title = "Array of non-pharmaceutical interventions") %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  scale_x_date(name = "", limits = as.Date(c("2020-03-10", "2020-04-15"))) + 
  scale_y_continuous(limits = c(0,500)) +
  theme(axis.text.x =  element_blank(), 
        legend.key.width = unit(10, "pt")) + 
  labs(fill = "") +
  facet_wrap(~ title)
leg1 <- get_legend(p1 + theme(legend.box.margin = margin(0, 0, 0, 0)))
p1
```

```{r}
intrv_labels = c("50% decrease in \n leisure visits", 
                 "50% decrease in \n education visits",
                 "50% decrease in \n total visits")

p2 <- county_set %>% 
  select(fips, 
         decrease_50_school_visits, 
         decrease_50_recreation_visiting,
         decrease_50_total_visiting) %>% 
  gather(key, value, -fips) %>% 
  mutate(key = factor(key, labels = intrv_labels), 
         title = "Array of mobility interventions") %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  scale_x_date(name = "", limits = as.Date(c("2020-03-10", "2020-04-15"))) + 
  scale_y_continuous(limits = c(0,500)) + 
  theme(legend.key.width = unit(10, "pt")) + 
  labs(fill = "") +
  facet_wrap(~ title)
leg2 <- get_legend(p2 + theme(legend.box.margin = margin(0, 0, 0, 0)))
p2
```

```{r}
prow1 <- plot_grid(p1 + theme(legend.position="none"), 
                   leg1,  ncol = 2, rel_widths = c(2,1))
prow2 <- plot_grid(p2 + theme(legend.position="none"), 
                   leg2, ncol = 2, rel_widths = c(2,1))
plot_grid(prow1, prow2, nrow = 2)
ggsave("intrv_timeline.pdf", width = 5, height = 4)
```

## Decrease on stayhome

* county_set_

```{r}
county_set_ %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>%
  group_by(nchs) %>% 
  summarise(mu = mean(decrease_on_stayhome_, na.rm = TRUE))
```

```{r}
plot_a <- county_set_ %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>% 
  ggplot() + 
  geom_density(aes(x = decrease_on_stayhome_, 
                   col = nchs, 
                   fill = nchs, 
                   alpha = if_else(nchs %in% c(1,6), 1, 0)), 
               size = 1) + 
  scale_alpha_continuous(range = c(0,0.25)) +
  guides(alpha = FALSE) + 
  labs(x = "Mobility decrease on stayhome") + 
  theme_minimal_grid() +
  theme(axis.text.y = element_blank())
#ggsave("./decrease.pdf", height = 3, width = 4.5)
plot_a
```

```{r}
diff_decrease_ <- county_set_ %>% 
  mutate(diff_decrease = roll_decrease_on_stayhome - min_decrease) %>% 
  pull(diff_decrease) 
  
quantile(diff_decrease_, c(.75, .80, .9), na.rm = TRUE)

plot_b <- county_set_ %>% 
  mutate(diff_decrease = roll_decrease_on_stayhome - min_decrease, 
         q = ifelse(diff_decrease <= 0.12, "1", NA)) %>%
  ggplot() + 
  geom_histogram(aes(x = diff_decrease, 
                     fill = q), 
                     col = "white", size = 0.7, alpha = 0.6) + 
  #geom_vline(xintercept = 0.12, lty = 2) +
  guides(fill = FALSE, col = FALSE) + 
  labs(x = "Additional decrease after stayhome") + 
  theme_minimal_grid() +
  annotate("text", x=0.06, y=30, label= "80%", size = 7)
#ggsave("./min_decrease.pdf", height = 3, width = 4.5)
plot_b
```


* county_set

```{r}
county_set %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>%
  group_by(nchs) %>% 
  summarise(mu = mean(decrease_on_stayhome_, na.rm = TRUE))
```

```{r}
plot_a <- county_set %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>% 
  ggplot() + 
  geom_density(aes(x = decrease_on_stayhome_, 
                   col = nchs, 
                   fill = nchs, 
                   alpha = if_else(nchs %in% c(1,6), 1, 0)), 
               size = 1) + 
  scale_alpha_continuous(range = c(0,0.25)) +
  guides(alpha = FALSE) + 
  labs(x = "Mobility decrease on stayhome") + 
  theme_minimal_grid() +
  theme(axis.text.y = element_blank())
#ggsave("./decrease.pdf", height = 3, width = 4.5)
plot_a
```

```{r}
diff_decrease_ <- county_set %>% 
  mutate(diff_decrease = roll_decrease_on_stayhome - min_decrease) %>% 
  pull(diff_decrease) 
  
quantile(diff_decrease_, c(.75, .80, .9), na.rm = TRUE)

plot_b <- county_set %>% 
  mutate(diff_decrease = roll_decrease_on_stayhome - min_decrease, 
         q = ifelse(diff_decrease <= 0.12, "1", NA)) %>%
  ggplot() + 
  geom_histogram(aes(x = diff_decrease, 
                     fill = q), 
                     col = "white", size = 0.7, alpha = 0.6) + 
  #geom_vline(xintercept = 0.12, lty = 2) +
  guides(fill = FALSE, col = FALSE) + 
  labs(x = "Additional decrease after stayhome") + 
  theme_minimal_grid() +
  annotate("text", x=0.06, y=30, label= "80%", size = 7)
#ggsave("./min_decrease.pdf", height = 3, width = 4.5)
plot_b
```

```{r}
# plot_grid(plot_a, plot_b, nrow = 1, rel_widths = c(1.2,1))
# ggsave("decrease.pdf", width = 9, height = 3)
```

## Threshold

* county_set_

```{r}
nchs_labels = c("Large central metro", 
                "Large fringe metro", 
                "Medium metro", 
                "Small metro", 
                "Micropolitan", 
                "None-core")
county_set_ %>% 
  group_by(threshold_day, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, threshold_day) %>% 
  group_by(nchs) %>% 
    mutate(sum_n = sum(n), 
           cum_n = cumsum(n), 
           rel_n = cum_n / sum_n
           ) %>% 
  ungroup() %>%
  mutate(NCHS = factor(nchs, labels = nchs_labels)) %>% 
  ggplot() +
    geom_line(aes(x = threshold_day, y = rel_n, col = NCHS), size = 1) + 
  labs(y="", x="Threshold day") + 
  theme_minimal_grid() + 
  theme(plot.margin = margin(l=-1))
ggsave("./threshold.pdf", width = 6, height = 3)
```

* county_set

```{r}
nchs_labels = c("Large central metro", 
                "Large fringe metro", 
                "Medium metro", 
                "Small metro", 
                "Micropolitan", 
                "None-core")
county_set %>% 
  group_by(threshold_day, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, threshold_day) %>% 
  group_by(nchs) %>% 
    mutate(sum_n = sum(n), 
           cum_n = cumsum(n), 
           rel_n = cum_n / sum_n
           ) %>% 
  ungroup() %>%
  mutate(NCHS = factor(nchs, labels = nchs_labels)) %>% 
  ggplot() +
    geom_line(aes(x = threshold_day, y = rel_n, col = NCHS), size = 1) + 
  labs(y="", x="Threshold day") + 
  theme_minimal_grid() + 
  theme(plot.margin = margin(l=-1))
ggsave("./threshold.pdf", width = 6, height = 3)
```

## Days between

* county_set_

```{r}
xx <- county_set_ %>% 
  select(fips, nchs, days_btwn_stayhome_thresh, days_btwn_decrease_thresh) %>% 
  pivot_longer(cols = starts_with("days_btwn"), 
               names_to = "intrv", 
               names_prefix = "days_btwn_", 
               values_to = "days_btwn")
nchs_labels = c("Large central metro", 
                "Large fringe metro", 
                "Medium metro", 
                "Small metro", 
                "Micropolitan", 
                "None-core")
intrv_labels = c("Mobility \n Decrease", "Stayhome \n Orders")
xx %>% 
  mutate(intrv = factor(intrv, labels = intrv_labels), 
         nchs = factor(nchs, labels = nchs_labels)) %>% 
  ggplot(aes(y = days_btwn, x = intrv, fill = nchs)) + 
  geom_boxplot() +  
  facet_wrap(~ nchs, ncol = 6) + 
  guides(fill = FALSE) + 
  labs(x = "", y = "Days since threshold") + 
  theme_minimal_grid() 
ggsave("./days_since_thresh_.pdf", width = 12, height = 4)
```

* county_set

```{r}
xx <- county_set %>% 
  select(fips, nchs, days_btwn_stayhome_thresh, days_btwn_decrease_thresh) %>% 
  pivot_longer(cols = starts_with("days_btwn"), 
               names_to = "intrv", 
               names_prefix = "days_btwn_", 
               values_to = "days_btwn")
nchs_labels = c("Large central metro", 
                "Large fringe metro", 
                "Medium metro", 
                "Small metro", 
                "Micropolitan", 
                "None-core")
intrv_labels = c("Mobility \n Decrease", "Stayhome \n Orders")
xx %>% 
  mutate(intrv = factor(intrv, labels = intrv_labels), 
         nchs = factor(nchs, labels = nchs_labels)) %>% 
  ggplot(aes(y = days_btwn, x = intrv, fill = nchs)) + 
  geom_boxplot() +  
  facet_wrap(~ nchs, ncol = 6) + 
  guides(fill = FALSE) + 
  labs(x = "", y = "Days since threshold") + 
  theme_minimal_grid() 
ggsave("./days_since_thresh.pdf", width = 12, height = 4)
```
