
```{r, include=FALSE}
library(tidyverse)
library(magrittr)
library(feather)
#library(lubridate)
library(usmap)
library(viridis)
library(gridExtra)
library(cowplot)
```

## county_train_

```{r}
county_train_stayhome <- read_feather('./county_train_stayhome.feather')
county_train_decrease <- read_feather('./county_train_decrease.feather')
```

```{r}
stayhome_set <- county_train_stayhome %>% 
  distinct(fips, nchs, pop, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome,
           days_btwn_stayhome_thresh, days_btwn_decrease_thresh,
           decrease_50_total_visiting, 
           decrease_on_stayhome, 
           roll_decrease_on_stayhome, 
           min_decrease)
decrease_set <- county_train_decrease %>% 
  distinct(fips, nchs, pop, threshold_day, 
           gt50, gt500, schools, restaurants, entertainment, stayhome, 
           days_btwn_stayhome_thresh, days_btwn_decrease_thresh,
           decrease_50_total_visiting, 
           decrease_on_stayhome, 
           roll_decrease_on_stayhome, 
           min_decrease)
length(unique(c(stayhome_set$fips, decrease_set$fips)))
county_set <- full_join(stayhome_set, decrease_set)
table(county_set$nchs)
```

```{r}
length(setdiff(stayhome_set$fips, decrease_set$fips))
length(setdiff(decrease_set$fips, stayhome_set$fips))
```

```{r}
nchs <- read_feather("./nchs.feather")
```

```{r}
table(nchs$nchs)
tot <- as.numeric(tapply(nchs$popul, nchs$nchs, sum, na.rm = TRUE))
set <- as.numeric(tapply(county_set$pop, county_set$nchs, sum, na.rm = TRUE))
set / tot
set
```

```{r}
county_set %>% 
  select(fips, gt50, gt500, schools, restaurants, entertainment, stayhome) %>% 
  gather(key, value, -fips) %>% 
  ggplot(aes(x = value, fill = key)) + 
  geom_bar() + 
  ggtitle("Intervention Dates")
```

```{r}
summary(as.numeric(c(county_set$gt50 - county_set$stayhome, 
                     county_set$gt50 - county_set$stayhome)))
summary(as.numeric(c(county_set$restaurants - county_set$stayhome, 
                     county_set$entertainment - county_set$stayhome)))
summary(as.numeric(c(county_set$schools - county_set$stayhome)))
```

```{r}
summary(c(county_set$gt50, 
          county_set$gt500, 
          county_set$schools, 
          county_set$entertainment, 
          county_set$restaurants))
summary(county_set$stayhome)
tapply(county_set$stayhome, county_set$nchs, summary)
```

```{r}
summary(county_set$decrease_50_total_visiting)
tapply(county_set$decrease_50_total_visiting, county_set$nchs, summary)
```

```{r}
county_set %>% 
  group_by(schools, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, schools) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = schools, y = cum_n, col = nchs))
```

```{r}
county_set %>% 
  group_by(stayhome, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, stayhome) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = stayhome, y = cum_n, col = nchs))
  
```

```{r}
county_set %>% 
  group_by(decrease_50_total_visiting, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, decrease_50_total_visiting) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = decrease_50_total_visiting, y = cum_n, col = nchs))
  
```

```{r}
county_set %>% 
  group_by(threshold_day, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, threshold_day) %>% 
  group_by(nchs) %>% 
    mutate(cum_n = cumsum(n)) %>% 
  ungroup() %>% 
  ggplot() +
    geom_line(aes(x = threshold_day, y = cum_n, col = nchs))
```


```{r}
county_set %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>% 
  ggplot() + 
  geom_density(aes(x = decrease_on_stayhome_, col = nchs))

county_set %>% 
  mutate(roll_decrease_on_stayhome_ = 1 - roll_decrease_on_stayhome) %>% 
  ggplot() + 
  geom_density(aes(x = roll_decrease_on_stayhome_, col = nchs))

county_set %>% 
  ggplot() + 
  geom_density(aes(x = min_decrease, col = nchs))
```

```{r}
county_set %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>% 
  ggplot() + 
  geom_density(aes(x = decrease_on_stayhome_, 
                   col = nchs, 
                   fill = nchs, 
                   alpha = if_else(nchs %in% c(1,6), 1, 0)), 
               size = 1) + 
  scale_alpha_continuous(range = c(0,0.25)) +
  guides(alpha = FALSE) + 
  labs(x = "Relative decrease in mobility") + 
  theme_minimal_grid() +
  theme(axis.text.y = element_blank())
ggsave("./decrease.pdf", height = 3, width = 4.5)
```

```{r}
county_set %>% 
   mutate(decrease_on_stayhome_ = 1 - decrease_on_stayhome) %>%
  group_by(nchs) %>% 
  summarise(mu = mean(decrease_on_stayhome_, na.rm = TRUE))
```


```{r}
county_set <- county_set %>% 
  mutate(days_btwn_decrease_stayhome = as.numeric(decrease_50_total_visiting - stayhome))

county_set %>% 
  ggplot() + 
  geom_density(aes(x = days_btwn_stayhome_thresh, col = nchs))

county_set %>% 
  ggplot() + 
  geom_density(aes(x = days_btwn_decrease_thresh, col = nchs)) 

county_set %>% 
  ggplot() + 
  geom_density(aes(x = days_btwn_decrease_stayhome, col = nchs))
```

```{r}
tapply(county_set$days_btwn_stayhome_thresh, county_set$nchs, median, na.rm = TRUE)
tapply(county_set$days_btwn_decrease_thresh, county_set$nchs, median, na.rm = TRUE)
tapply(county_set$days_btwn_decrease_stayhome, county_set$nchs, median, na.rm = TRUE)
```

```{r}
county_train_stayhome %>% 
  filter(date == stayhome) %>% 
  select(fips, nchs, date, stayhome, days_since_thresh)
```

```{r}
plot_a <- county_set %>% 
  group_by(threshold_day, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, threshold_day) %>% 
  group_by(nchs) %>% 
    mutate(sum_n = sum(n), 
           cum_n = cumsum(n), 
           rel_n = cum_n / sum_n, 
           num_plot = "a"
           ) %>% 
  ungroup() %>%
  ggplot() +
    geom_line(aes(x = threshold_day, y = rel_n, col = nchs), size = 1) +
  labs(y="", x="a)") + 
  guides(col = FALSE) +
  theme_minimal_grid() + 
  theme(plot.margin = margin(l=-1))
plot_a
```

```{r}
plot_b <- county_set %>% 
  select(nchs, days_btwn_stayhome_thresh) %>% 
  filter(!is.na(days_btwn_stayhome_thresh)) %>% 
  group_by(days_btwn_stayhome_thresh, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, days_btwn_stayhome_thresh) %>% 
  group_by(nchs) %>% 
    mutate(sum_n = sum(n), 
           cum_n = cumsum(n), 
           rel_n = cum_n / sum_n,
           num_plot = "b"
           ) %>% 
  ungroup() %>% 
  ggplot() +
   geom_line(aes(x = days_btwn_stayhome_thresh, y = rel_n, col = nchs), size = 1) +
   scale_x_continuous(name = "b)",
                    breaks = c(-30,-20,-10,0,10,20,30),
                    limits = c(-35, 30)) +
   geom_vline(xintercept = 0, lty = 2, size = 0.75) +
  labs(y="") + 
  guides(col = FALSE) +
  theme_minimal_grid() + 
  theme(axis.text.y =  element_blank(), 
        plot.margin = margin(l=-1))  
plot_b
```

```{r}
plot_c <- county_set %>% 
  select(nchs, days_btwn_decrease_thresh) %>% 
  filter(!is.na(days_btwn_decrease_thresh)) %>% 
  group_by(days_btwn_decrease_thresh, nchs) %>% 
    summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(nchs, days_btwn_decrease_thresh) %>% 
  group_by(nchs) %>% 
    mutate(sum_n = sum(n), 
           cum_n = cumsum(n), 
           rel_n = cum_n / sum_n, 
           num_plot = "c"
           ) %>% 
  ungroup() %>% 
  ggplot() +
   geom_line(aes(x = days_btwn_decrease_thresh, y = rel_n, col = nchs), size = 1) +
   geom_vline(xintercept = 0, lty = 2, size = 0.75) +
   scale_x_continuous(name = "c)",
                    breaks = c(-30,-20,-10,0,10,20,30),
                    limits = c(-35, 30)) + 
  labs(y="") + 
  theme_minimal_grid() + 
  theme(axis.text.y =  element_blank(), 
        plot.margin = margin(l=-1))  
plot_c
```

```{r}
plot_grid(plot_a, plot_b, plot_c, nrow = 1, rel_widths = c(1,1,1.15))
ggsave("timing.pdf", width = 9, height = 3)
```



